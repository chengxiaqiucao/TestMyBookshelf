{% extends "base.html" %}

{% block head %}
<!-- 引入 FullCalendar 相关资源 -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.10/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.10/main.min.js'></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 返回按钮 -->
    <div class="mb-4">
        <a href="/plans" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回列表
        </a>
    </div>

    <!-- 日历视图 -->
    <div class="card">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" id="viewPlanLink" class="btn btn-primary">查看计划</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 准备日历数据
    const events = [
        {% for task in tasks %}
        {
            id: '{{ task[0] }}',
            title: '{{ task[4] }}',
            start: '{{ task[2] }}',
            end: '{{ task[3] }}',
            url: '/plan/{{ task[1] }}',
            backgroundColor: '{% if task[5] == "已完成" %}#198754{% elif task[5] == "进行中" %}#0d6efd{% elif task[5] == "已取消" %}#6c757d{% else %}#ffc107{% endif %}',
            borderColor: '{% if task[5] == "已完成" %}#198754{% elif task[5] == "进行中" %}#0d6efd{% elif task[5] == "已取消" %}#6c757d{% else %}#ffc107{% endif %}',
            extendedProps: {
                description: '{{ task[4] }}',
                status: '{{ task[5] }}',
                executor: '{{ task[6] or "未指定" }}',
                bookTitle: '{{ task[7] }}'
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // 初始化日历
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        locale: 'zh-cn',
        events: events,
        eventClick: function(info) {
            // 显示任务详情
            const task = info.event;
            const details = `
                <h6 class="mb-3">${task.extendedProps.bookTitle}</h6>
                <p><strong>任务：</strong>${task.extendedProps.description}</p>
                <p><strong>状态：</strong><span class="badge ${getStatusBadgeClass(task.extendedProps.status)}">${task.extendedProps.status}</span></p>
                <p><strong>执行者：</strong>${task.extendedProps.executor}</p>
                <p><strong>时间：</strong>${formatDateTime(task.start)} ~ ${formatDateTime(task.end)}</p>
            `;
            document.getElementById('taskDetails').innerHTML = details;
            document.getElementById('viewPlanLink').href = task.url;
            
            const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
            taskModal.show();
        },
        eventDidMount: function(info) {
            // 添加工具提示
            info.el.title = `${info.event.extendedProps.bookTitle} - ${info.event.extendedProps.description}`;
        }
    });
    calendar.render();
});

// 辅助函数：获取状态标签样式
function getStatusBadgeClass(status) {
    switch(status) {
        case '已完成': return 'bg-success';
        case '进行中': return 'bg-primary';
        case '已取消': return 'bg-secondary';
        default: return 'bg-warning';
    }
}

// 辅助函数：格式化日期时间
function formatDateTime(dateStr) {
    if (!dateStr) return '未设置';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>

<style>
.fc-event {
    cursor: pointer;
}
.fc-event:hover {
    opacity: 0.9;
}
.fc-toolbar-title {
    font-size: 1.5em !important;
}
</style>
{% endblock %} 